---
title: "Cirrhosis Patient Survival Prediction"
author: Chen Liang, Jessie Li, Xinyi Shang, Ixtaccihuatl Obregon, Jane Ma
date: ""
output: pdf_document
fontsize: 12pt
header-includes:
  - \usepackage{setspace}
  - \setstretch{1.5}
bibliography: references.bib
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, out.width = "80%", fig.align = "center")
options(knitr.kable.NA = '')
library(tidyverse)
library(RColorBrewer)
library(corrplot)
library(gtsummary)
library(flextable)
library(stringr)
library(survival)
library(survminer)
library(kableExtra)
library(ggplot2)
library(ggpubr)
library(gridExtra)
library(MASS)
library(glmnet)

write_matex <- function(x) {
  begin <- "$$\\begin{bmatrix}"
  end <- "\\end{bmatrix}$$"
  X <-
    apply(x, 1, function(x) {
      paste(
        paste(x, collapse = "&"),
        "\\\\"
      )
    })
  writeLines(c(begin, X, end))
}
theme_set(
  theme_bw()+
  theme(
    plot.title = element_text(size = 16, hjust = 0.5),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 10),
    axis.line = element_line(color = "black", size = 0.5),
  )
)
```

# Background

## Cirrhosis Overview

## Related research

## Study Objective

# Methods

## Dataset Description

The dataset used in this analysis originates from a study on primary biliary cirrhosis (PBC) conducted at the Mayo Clinic. It contains data for 276 patients, each characterized by 20 variables reflecting demographic, clinical, and laboratory features. Demographic variables include age and sex. Clinical features include the presence or absence of ascites, hepatomegaly, spiders, and edema, as well as the histologic stage of the disease. Laboratory markers, such as bilirubin, albumin, copper, alsekaline phosphatase (alk_phos), SGOT, triglycerides, platelets, and prothrombin time, provide insight into liver function and disease severity. Outcome measures include the number of days from registration to death, liver transplantation, or censoring, and patient status. For the purpose of analysis, censored cases (C: censored, CL: censored due to liver transplantation) were grouped together as a single category (C), while death (D) remained as a separate outcome.

Missing data were handled by removing rows with incomplete values. Out of the original dataset, 142 entries were removed due to missing information, resulting in a final dataset of 276 complete cases. This approach ensures the integrity of statistical analysis by avoiding imputation biases. By excluding records with missing data, the analysis avoids biases introduced by imputation but acknowledges the trade-off between sample size and data quality.

As shown in Table 1, the baseline characteristics of patients reveal significant differences across survival outcomes. Patients who died had the shortest survival time, highest bilirubin, alkaline phosphatase, and SGOT levels, as well as the most advanced disease stage (50% in stage 4). In contrast, younger patients were more likely to undergo liver transplantation, with a mean age of 40.7 years compared to 53.4 years in the death group. Clinical features such as ascites, hepatomegaly, and edema were more prevalent among those who died or underwent transplantation, indicating disease severity. Additionally, lower albumin levels and prolonged prothrombin time in the death group highlight impaired liver function as a key prognostic factor.

```{r}
cirrhosis <- read_csv("data/cirrhosis.csv")|> 
  janitor::clean_names() |>
  mutate(age = round(age / 365),
         sex = if_else(sex == "M", "Male", "Female"), 
         ascites = if_else(ascites == "N", "No", "Yes"), 
         hepatomegaly = if_else(hepatomegaly == "N", "No", "Yes"),
         spiders = if_else(spiders == "N", "No", "Yes"), 
         edema = if_else(edema == "N", "No", "Yes"))|>
  na.omit()
```

\begingroup
\setstretch{1}

```{r, out.width="80%", out.height="80%", warning=FALSE}
theme_gtsummary_journal(journal = "nejm")

cirrhosis_df <- cirrhosis |> 
  mutate(
    status = case_when(
      status == "C" ~ "Censored",
      status == "CL" ~ "Censored due to liver tx",
      status == "D" ~ "Death",
      TRUE ~ status))

table_1 <- cirrhosis_df |>
  dplyr::select(-id) |> 
  tbl_summary(
    by = status,
    statistic = list(
      all_continuous() ~ "{mean} / {median} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    digits = all_continuous() ~ 1,
    missing = "no",
    label = list(
    n_days ~ "N_days",
    drug ~ "Drug",
    age ~ "Age",
    sex ~ "Sex",
    ascites ~ "Ascites",
    hepatomegaly ~ "Hepatomegaly",
    spiders ~ "Spiders",
    edema ~ "Edema",
    bilirubin ~ "Bilirubin",
    cholesterol ~ "Cholesterol",
    albumin ~ "Albumin",
    copper ~ "Copper",
    alk_phos ~ "Alk_phos",
    sgot ~ "SGOT",
    tryglicerides ~ "Tryglicerides",
    platelets ~ "Platelets",
    prothrombin ~ "Prothrombin",
    stage ~ "Stage"
  )) |>
  modify_caption("Baseline Characteristics") |> 
  as_flex_table() |> 
  set_table_properties(width = 0.8, layout = "autofit") # Set width to 80%
  
table_1
```
 
\endgroup

## Survival Analysis

### Kaplan-Meier Estimates

The Kaplan-Meier estimator was used to estimate survival probabilities. This method provides a non-parametric estimation of the survival function \( S(t) \), defined as the probability of survival beyond time \( t \). For a set of ordered survival times \( t_1, t_2, \dots, t_k \), the Kaplan-Meier survival estimate is computed as:

\[
\hat{S}(t) = \prod_{t_i \leq t} \left(1 - \frac{d_i}{n_i}\right)
\]

where:

- \( d_i \) is the number of events (deaths or censoring) at time \( t_i \),
- \( n_i \) is the number of individuals at risk just before time \( t_i \).

The Kaplan-Meier survival curves were plotted for overall survival, as well as stratified by key variables such as treatment type (D-penicillamine vs. placebo), presence of edema, and histological stage of disease. Confidence intervals were calculated for survival probabilities to assess the precision of estimates.

### Log-Rank Test

The log-rank test was employed to compare survival distributions between groups, such as those defined by drug treatment, edema status, and disease stage. The log-rank test statistic is computed as:

\[
\chi^2 = \sum \frac{(O_i - E_i)^2}{E_i}
\]

where:

- \( O_i \) is the observed number of events in group \( i \),
- \( E_i \) is the expected number of events in group \( i \), under the null hypothesis.

This statistic follows a chi-squared distribution with degrees of freedom equal to the number of groups minus one. P-values were calculated to assess the significance of differences in survival.

### Cox PH

Forward, backward, and stepwise selection were used to identify relevant predictors, while LASSO was applied to incorporate shrinkage and reduce overfitting. Collett’s approach was included to enhance robustness in model selection. Forward, backward, and stepwise selection were conducted in R using the `stepAIC()` function from the MASS package for forward, backward, and stepwise selection, which performs model selection based on the Akaike Information Criterion (AIC). The LASSO approach was implemented using the glmnet package, and Collett’s model selection approach was performed manually following the guidelines outlines:  

1. Fit a univariate model for each covariate, and identify the predictors significant at $p_1$ = 0.20.
2. Fit a multivariate model with all significant variable. Perform backward selection.
3. Starting with final step (2) model, consider each of the non-significant variables from step (1) using forward selection, with significance level p3, say 0.10
4. Do final pruning of main-effects model (omit variables that are non-significant, add any that are significant), using stepwise regression with significance level p4. At this stage, you may also consider adding interactions between any of the main effects currently in the model, under the hierarchical principle.  

Interaction term between drug and other variables were included to assess the possibility that the effect of drug on the outcome might differ across levels of other variables. The variable drug was forcibly included in all models as it serves as the primary focus of the analysis. Final model selection was guided by AIC as the primary selection criterion. 

We used a cox proportional hazards model to assess the effect of the covariates on the hazard of developing cirrhosis. The assumption of the model is that hazard ratios between groups is constant over time. In addition, the effects of the covariates on the hazard are assumed to be proportional. To determine if the Cox PH model violated the proportional hazard assumptions we used the cox.zph() function in R. 

After the proportional hazards assumption is met, interaction terms between model covariates are considered using the likelihood ratio test. Suppose there are $p$ covariates in the model. First, each one of the $\frac{p(p-1)}{2}$ interaction terms is added to the model to obtain $\frac{p(p-1)}{2}$ $p$ value, and the interaction term with the lowest $p$ value is added to the model. Then, the rest of the interaction terms are added to the new model one by one to obtain the $p$ value. The process is repeated until $p>0.05$ holds for all the likelihood ratio tests. The model with the added interaction terms is the final model.

With the final model, model evaluation is conducted. Deviance residuals and Cox-Snell residuals are used to evaluate model fit. For models with good fit, deviance residuals should be randomly distributed around 0, and for KM survival estimates using Cox-Snell residuals as the pseudo survival time, $log(-log(S(t)))$ should be approximately equal to $log(t)$. Influence diagnostics with LD option is used to identify influential individuals. It evaluates how much the log-likelihood would change if the $i^{th}$ person was removed from the sample. After identifying outliers and influential individuals, these subjects are removed from the sample and the model is re-fit to see if the results would change.

# Results

## Descriptive Statistics (EDA)

Figure 1 provides insights into the distributions of continuous variables through boxplots, revealing heterogeneity in liver disease severity. Variables such as bilirubin, alkaline phosphatase, SGOT, and prothrombin exhibit highly skewed distributions with significant outliers, reflecting the heterogeneity in liver disease severity among patients. These patterns highlight the diversity in clinical markers and their potential implications for survival outcomes.

```{r fig.cap="Boxplots for Continuous Variables", fig.pos="H"}
conti_vars = cirrhosis |>
  dplyr::select(age, bilirubin, cholesterol, albumin, copper, alk_phos, sgot, tryglicerides, platelets,prothrombin)

# Boxplot for all continuous variables
par(mfrow = c(2, 5), oma = c(2, 2, 3, 1), mar = c(4, 4, 2, 1))
conti_names <- names(conti_vars)

p1 <- for (i in seq_along(conti_names)) {
  boxplot(conti_vars[[conti_names[i]]],
          main = conti_names[i],
          ylab = "Value",
          col = "lightblue",
          outline = TRUE)  # Show outliers
}
```

As shown in the Figure 2, the majority of patients are female, lack ascites, and are evenly distributed regarding hepatomegaly. Most are in stages 2 and 3 of the disease, with a notable proportion in stage 4, indicating disease progression. Drug distribution is balanced between D-penicillamine and placebo groups, supporting comparability in treatment outcomes.

```{r fig.cap="Barplots for Categorical Variables", fig.pos="H"}
cate_vars = cirrhosis |>
  dplyr::select(drug, sex, ascites, hepatomegaly, spiders, edema, stage)

par(mfrow = c(2, 4),  # 2 rows, 5 columns
    oma = c(2, 2, 3, 1),  # Outer margins
    mar = c(4, 4, 2, 1),  # Inner margins for individual plots
    mgp = c(2, 1, 0))     # Margins for axis labels and titles

colors <- c(brewer.pal(9, "YlGnBu"), "darkblue") 

barplot(table(cate_vars$drug), main = "Drug", ylab = "Count",col = colors[1])
barplot(table(cate_vars$sex), main = "Sex", ylab = "Count",col = colors[2])
barplot(table(cate_vars$ascites), main = "Ascites", ylab = "Count", col = colors[3])
barplot(table(cate_vars$hepatomegaly), main = "Hepatomegaly", ylab = "Count", col = colors[4])
barplot(table(cate_vars$spiders), main = "Spiders", ylab = "Count", col = colors[5])
barplot(table(cate_vars$edema), main = "Edema", ylab = "Count", col = colors[6])
barplot(table(cate_vars$stage), main = "Stage", ylab = "Count", col = colors[7])
```

Finally, Figure 3 presents the correlation matrix, which highlights strong positive associations between bilirubin, alkaline phosphatase, and SGOT, emphasizing their relationship with liver dysfunction. In contrast, albumin and platelet counts negatively correlate with disease stage, indicating their decline as the disease advances. These relationships highlight key biomarkers of cirrhosis progression.

```{r fig.cap="Correlation Matrix", fig.pos="H"}
numeric_cirr <- cirrhosis |>
  select_if(is.numeric)

cor_matrix <- cor(numeric_cirr, use = "complete.obs")

corrplot(cor_matrix, method = "circle", type = "lower", order = "hclust")
```

## KM and Log-Rank Test

```{r echo = FALSE, message = F, warning = F}
cirrhosis <- read_csv("../data/cirrhosis.csv")|> 
  janitor::clean_names() |>
  mutate(age = round(age / 365),
         sex = if_else(sex == "M", "Male", "Female"), 
         ascites = if_else(ascites == "N", "No", "Yes"), 
         hepatomegaly = if_else(hepatomegaly == "N", "No", "Yes"),
         spiders = if_else(spiders == "N", "No", "Yes"), 
         edema = if_else(edema == "N", "No", "Yes")) |>
  drop_na()


cirrhosis$event <- ifelse(cirrhosis$status == "D", 1, 0)

surv_object <- Surv(time = cirrhosis$n_days, event = cirrhosis$event)

km_fit <- survfit(surv_object ~ 1, data = cirrhosis)

plot_all = ggsurvplot(km_fit, conf.int = TRUE, 
           title = "(a) Overall",
           xlab = "Days", ylab = "Survival Probability",
           legend.title = "",
           ggtheme = theme_minimal())

```

```{r echo = FALSE, message = F, warning = F}
km_fit_drug <- survfit(surv_object ~ drug, data = cirrhosis)

plot_drug = ggsurvplot(km_fit_drug, conf.int = TRUE, 
           title = "(b) Drug Type",
           xlab = "Days", ylab = " ",
           legend.title = "",
           ggtheme = theme_minimal() )

```

```{r survivalcurveKM, echo=FALSE, message = F, warning  = F, fig.cap="Kaplan-Meier Survival Curve"}

# Fit survival curves by edema
km_fit_edema <- survfit(surv_object ~ edema, data = cirrhosis)
plot_edema <- ggsurvplot(
  km_fit_edema, conf.int = TRUE, 
  title = "(a) Edema",
  xlab = "Days", ylab = "Survival Probability",
  legend.title = "",
  ggtheme = theme_minimal() 
)

# Fit survival curves by stage
km_fit_stage <- survfit(surv_object ~ stage, data = cirrhosis)
plot_stage <- ggsurvplot(
  km_fit_stage, conf.int = TRUE, 
  title = "(b) Stage",
  xlab = "Days", ylab = " ",
  legend.title = "",
  ggtheme = theme_minimal() +
    theme(legend.text = element_text(size = 6)) # Adjust legend text size

)

# Arrange the plots side by side with adjusted spacing
grid.arrange(
  plot_all$plot,
  plot_drug$plot,
  plot_edema$plot, 
  plot_stage$plot, 
  ncol = 2, 
  widths = c(1, 1) # Equal sizing for both plots
)

```

```{r echo = FALSE, message = F, warning = F}
max_time <- max(cirrhosis$n_days, na.rm = TRUE)
max_years <- floor(max_time / 365)
yearly_times <- seq(0, max_years * 365, by = 365)

km_summary_yearly <- summary(km_fit, times = yearly_times)

# Create the data frame from the KM summary
surv_yearly_table <- data.frame(
  years = yearly_times / 365,
  n_risk = km_summary_yearly$n.risk,
  n_event = km_summary_yearly$n.event,
  n_censor = km_summary_yearly$n.censor,
  survival = km_summary_yearly$surv,
  lower_ci = km_summary_yearly$lower,
  upper_ci = km_summary_yearly$upper
)

# If time=0 row does not exist, add it
if (!any(yearly_times == 0)) {
  surv_yearly_table <- rbind(
    data.frame(
      years = 0,
      n_risk = km_fit$n.risk[1],
      n_event = 0,
      n_censor = 0,
      survival = 1,
      lower_ci = 1,
      upper_ci = 1
    ),
    surv_yearly_table
  )
}

surv_yearly_table <- surv_yearly_table[order(surv_yearly_table$years), ]

interval_labels <- sapply(2:nrow(surv_yearly_table), function(i) {
  paste0("[", surv_yearly_table$years[i-1], ", ", surv_yearly_table$years[i], ")")
  })

surv_yearly_intervals <- surv_yearly_table[-1, ] # Remove the first row if needed

surv_yearly_intervals$interval <- interval_labels

surv_yearly_intervals$n_risk[1] <- surv_yearly_table$n_risk[1]
  
for (i in 2:nrow(surv_yearly_intervals)) {
  surv_yearly_intervals$n_risk[i] <- surv_yearly_intervals$n_risk[i-1] - 
                                       surv_yearly_intervals$n_event[i-1] - 
                                       surv_yearly_intervals$n_censor[i-1]
}

surv_table = surv_yearly_intervals %>%
  rownames_to_column() %>%         # Convert any existing row names to a column
  dplyr::select(-rowname) %>%             # Remove the converted row names column
  dplyr::select(interval, n_risk, n_event, n_censor, survival, lower_ci, upper_ci)|>
  as.data.frame()
```

\begingroup
\setstretch{1}

```{r lifetable, echo = FALSE, message = F, warning = F, out.width = "80%"}
kable(
  surv_table, 
  caption = "Kaplan-Meier Survival Summary in Years",
      col.names = c("Time Interval (Years)", "At Risk", "Events", "Censored", "Survival Probability", "Lower CI", "Upper CI"),
  digits = 2,
  booktabs = TRUE
) %>%
  kable_styling(full_width = FALSE)
```

\endgroup

The Kaplan-Meier survival analysis provides valuable insights into overall survival probabilities over time. The survival curve shows a consistent decline in survival probability Figure \ref{fig:survivalcurveKM} (a), with a median survival probability of 9 years and a 75% survival probability of 4 years. Key survival probabilities at yearly intervals are summarized in Table \ref{tab:lifetable}.

\begingroup
\setstretch{1}

```{r logrankKM, echo = FALSE, message = F, warning = F}
log_rank_test <- survdiff(surv_object ~ drug, data = cirrhosis)

log_rank_results_drug <- data.frame(
  Group = "Drug",
  Statistic = log_rank_test$chisq,
  Degrees_of_Freedom = 1,
  P_Value = log_rank_test$pvalue
) 

log_rank_results_drug[, -1] <- log_rank_results_drug[, -1] %>%
  mutate(across(where(is.numeric), ~ round(., 4)))


# Log-rank test for edema
log_rank_test_edema <- survdiff(surv_object ~ edema, data = cirrhosis)
log_rank_results_edema <- data.frame(
  Group = "Edema",
  Statistic = log_rank_test_edema$chisq,
  Degrees_of_Freedom = 1,
  P_Value = ifelse(log_rank_test_edema$pvalue < 0.0001, "<0.0001", log_rank_test_edema$pvalue)
)

# Log-rank test for stage
log_rank_test_stage <- survdiff(surv_object ~ stage, data = cirrhosis)
log_rank_results_stage <- data.frame(
  Group = "Stage",
  Statistic = log_rank_test_stage$chisq,
  Degrees_of_Freedom = 3,
  P_Value = ifelse(log_rank_test_stage$pvalue < 0.0001, "<0.0001", log_rank_test_stage$pvalue)
)

log_rank_results_combined <- rbind(log_rank_results_drug,
                                   log_rank_results_edema, 
                                   log_rank_results_stage)

kable(
  log_rank_results_combined[, -1], # Exclude the "Group" column for main table
  digits = 4,
  col.names = c("Chi-Squared Statistic", "Degrees of Freedom", "P-Value"),
  caption = "Log-Rank Test Results"
) %>%
  pack_rows("Drug", 1, 1) |>
  pack_rows("Edema", 2, 2) |>
  pack_rows("Stage", 3, 3)     
```

\endgroup

A comparison of survival probabilities between the two treatment groups—D-penicillamine and placebo—demonstrated no statistically significant differences. The log-rank test produced a p-value of 0.5246, far above the significance threshold of 0.05. The Kaplan-Meier curves for these groups overlap substantially, indicating that D-penicillamine does not significantly improve survival outcomes compared to placebo (Table \ref{tab:logrankKM}, Figure \ref{fig:survivalcurveKM} (b)).

Edema shows as a critical factor influencing survival, as highlighted by the log-rank test (p-value < 0.0001). Patients without edema exhibit significantly better survival probabilities than those with edema (Table \ref{tab:logrankKM}, Figure \ref{fig:survivalcurveKM} (c)). The stark contrast in survival curves underscores edema as a key predictor of survival and its importance in risk stratification.

The histologic stage of the disease also plays a significant role in survival outcomes. The log-rank test for stage groups yielded a highly significant p-value (< 0.0001), indicating marked differences in survival curves across stages (Table \ref{tab:logrankKM}, Figure \ref{fig:survivalcurveKM} (d)). Patients in advanced stages (3 and 4) have substantially lower survival probabilities compared to those in earlier stages (1 and 2).

## Cox Model

### Feature Selection

```{r colletts, include = F}
main_effects_terms = cirrhosis |>
  dplyr::select(-matches("^(id|n_days|status|event)")) |>
  colnames()

initial_models = map(main_effects_terms, \(x) 
  coxph(as.formula(paste0("surv_object ~", x)), data = cirrhosis)
)

# Extract significant variables (p < 0.20)
initial_significant_vars = map(initial_models, \(x) 
  summary(x)$coefficients[, "Pr(>|z|)"] < 0.20
) |> unlist()

significant_var_names = main_effects_terms[initial_significant_vars]

# Step 2: Fit multivariate model and perform backward selection
initial_terms = significant_var_names
formula_str = paste("surv_object ~ drug +", paste(initial_terms, collapse = " + "))
initial_model = coxph(as.formula(formula_str), data = cirrhosis, model = TRUE)

# Extract the exact data used in the initial model
cirrhosis_clean = cirrhosis[complete.cases(cirrhosis[, c("n_days", "status", "drug", "event", main_effects_terms)]), ]

# Start backward selection
current_model = initial_model
current_terms = initial_terms

while (TRUE) {
  terms_to_test = setdiff(current_terms, "drug")
  if (length(terms_to_test) == 0) break
  
  best_model = current_model
  term_to_remove = NULL
  
  for (term in terms_to_test) {
    reduced_terms = setdiff(current_terms, term)
    formula_str = paste("surv_object ~ drug +", paste(reduced_terms, collapse = " + "))
    reduced_model = coxph(as.formula(formula_str), data = cirrhosis_clean)
    
    lrt = anova(current_model, reduced_model, test = "LRT")
    lrt_p_value = lrt[2, "Pr(>|Chi|)"]
    
    if (lrt_p_value > 0.10) {
      best_model = reduced_model
      term_to_remove = term
      break
    }
  }
  
  if (is.null(term_to_remove)) break
  
  current_model = best_model
  current_terms = setdiff(current_terms, term_to_remove)
}

backward_model = current_model

# Step 3: Forward selection of previously non-significant variables
current_model = backward_model
excluded_vars = setdiff(significant_var_names, attr(terms(current_model), "term.labels"))

for (var in excluded_vars) {
  current_terms = attr(terms(current_model), "term.labels")
  formula_terms = unique(c(current_terms, var))
  formula_str = paste("surv_object ~", paste(union("drug", formula_terms), collapse = " + "))
  
  extended_model = coxph(as.formula(formula_str), data = cirrhosis_clean)
  lrt = anova(current_model, extended_model, test = "LRT")
  lrt_p_value = lrt[2, "Pr(>|Chi|)"]
  
  if (lrt_p_value <= 0.10) {
    current_model = extended_model
  }
}

forward_model = current_model

# Step 4: Final stepwise selection (backward + forward)
current_model = forward_model  

while (TRUE) {
  current_terms = attr(terms(current_model), "term.labels")
  if (length(setdiff(current_terms, "drug")) == 0) break
  
  best_model = current_model
  term_to_remove = NULL
  term_to_add = NULL
  
  for (term in setdiff(current_terms, "drug")) {
    remaining_terms = setdiff(current_terms, term)
    formula_str = paste("surv_object ~", paste(union("drug", remaining_terms), collapse = " + "))
    reduced_model = coxph(as.formula(formula_str), data = cirrhosis_clean)
    
    lrt = anova(current_model, reduced_model, test = "LRT")
    lrt_p_value = lrt[2, "Pr(>|Chi|)"]
    
    if (lrt_p_value > 0.10) {
      best_model = reduced_model
      term_to_remove = term
      break
    }
  }
  
  excluded_vars = setdiff(significant_var_names, current_terms)
  for (var in excluded_vars) {
    formula_terms = union(current_terms, var)
    formula_str = paste("surv_object ~", paste(union("drug", formula_terms), collapse = " + "))
    extended_model = coxph(as.formula(formula_str), data = cirrhosis_clean)
    
    lrt = anova(current_model, extended_model, test = "LRT")
    lrt_p_value = lrt[2, "Pr(>|Chi|)"]
    
    if (lrt_p_value <= 0.10) {
      best_model = extended_model
      term_to_add = var
      break
    }
  }
  
  if (is.null(term_to_remove) && is.null(term_to_add)) break
  
  current_model = best_model
}

# Interaction terms
main_effects = setdiff(attr(terms(current_model), "term.labels"), "drug")
for (var in main_effects) {
  interaction_term = paste("drug:", var)
  interaction_formula = paste(deparse(current_model$formula), "+", interaction_term)
  
  interaction_model = coxph(as.formula(interaction_formula), data = cirrhosis_clean)
  
  lrt = anova(current_model, interaction_model, test = "LRT")
  lrt_p_value = lrt[2, "Pr(>|Chi|)"]
  
  if (lrt_p_value <= 0.10) {
    current_model = interaction_model
  }
}

colletts_model = current_model
```

```{r forward, include = F}
forward_model = stepAIC(
  coxph(
    Surv(n_days, event) ~ .,
    data = cirrhosis |>
      dplyr::select(-status) |>
      dplyr::select(-id) |> na.omit()
  ),
  direction = "forward",
  trace = F
)

# Forward already has drug

forward_model_interact = stepAIC(
  coxph(
    Surv(n_days, event) ~ 1,
    data = cirrhosis |>
      dplyr::select(-status) |>
      dplyr::select(-id) |> na.omit()
  ),
  scope = list(lower = ~ 1, upper = as.formula(paste(
    "~ . +",
    paste0(
      "drug:",
      cirrhosis |> dplyr::select(-id, -n_days, -status, -drug, -event) |> colnames(),
      collapse = " + "
    )
  ))),
  tract = F,
  direction = "forward"
)

forward_model_interact = coxph(
  as.formula(
    paste(
      "Surv(n_days, event)  ~",
      forward_model_interact$formula[3],
      "+ drug"
    )
  ),
  data = cirrhosis |>
    dplyr::select(-status) |>
    dplyr::select(-id) |> na.omit()
)
```

```{r backward, include = F}
backward_model = stepAIC(
  coxph(
    Surv(n_days, event) ~ .,
    data = cirrhosis |>
      dplyr::select(-status) |>
      dplyr::select(-id) |> na.omit()
  ),
  direction = "backward",
  trace = F
)

backward_model = coxph(
  as.formula(
    paste("Surv(n_days, event)  ~", backward_model$formula[3], "+ drug")
  ),
  data = cirrhosis |>
    dplyr::select(-status) |>
    dplyr::select(-id) |> na.omit()
)

backward_model_interact = stepAIC(
  coxph(
    as.formula(paste(
      "Surv(n_days, event) ~ . +",
      paste0(
        "drug:",
        cirrhosis |> dplyr::select(-id, -n_days, -status, -drug, -event) |> colnames(),
        collapse = " + "
      )
    )),
    data = cirrhosis |>
      dplyr::select(-status) |>
      dplyr::select(-id) |> na.omit()
  ),
  direction = "backward",
  trace = F
)
```

```{r stepwise, include = F}
stepwise_model = stepAIC(
  coxph(
    Surv(n_days, event) ~ .,
    data = cirrhosis |>
      
      dplyr::select(-status) |>
      dplyr::select(-id) |> na.omit()
  ),
  direction = "both",
  trace = F
)
stepwise_model = coxph(
  as.formula(
    paste("Surv(n_days, event)  ~", stepwise_model$formula[3], "+ drug")
  ),
  data = cirrhosis |>
    dplyr::select(-status) |>
    dplyr::select(-id) |> na.omit()
)

stepwise_model_interact = stepAIC(
  coxph(
    as.formula(paste(
      "Surv(n_days, event) ~ . +",
      paste0(
        "drug:",
        cirrhosis |> dplyr::select(-id, -n_days, -status, -drug, -event) |> colnames(),
        collapse = " + "
      )
    )),
    data = cirrhosis |>
      dplyr::select(-status) |>
      dplyr::select(-id) |> na.omit()
  ),
  direction = "both",
  trace = F
)
```

```{r LASSO, include = F}
x = model.matrix(Surv(n_days, event) ~ . - id, cirrhosis |> na.omit() |> dplyr::select(-status))[, -1]
y = Surv(cirrhosis |>
           na.omit() |>
           pull(n_days), 
         cirrhosis |>
           na.omit() |>
           pull(event))
cv_model = cv.glmnet(x, y, family = "cox", alpha = 1)
best_lambda = cv_model$lambda.min
selected_coefficients = coef(cv_model, s = best_lambda)
selected_var_name = rownames(selected_coefficients)[which(selected_coefficients != 0)]
selected_var_name = map(selected_var_name, str_remove_all, "Yes|Placebo") |> unlist()
lasso_model = coxph(as.formula(paste0("surv_object ~ ", paste(selected_var_name, collapse = "+"))), data = cirrhosis |>
                               dplyr::select(-id) |> na.omit())

lasso_model = coxph(as.formula(
  paste(
    "surv_object ~",
    lasso_model$formula[3],
    "+ drug"
  )
), data = cirrhosis  |> 
  dplyr::select(-status) |>
  dplyr::select(-id) |> na.omit())
```

```{r model_comparison, echo=FALSE}
model_comparison = data.frame(
  Model = c(
    "Forward",
    "Forward with Interaction",
    "Backward",
    "Backward with Interaction",
    "Stepwise",
    "Stepwise with Interaction",
    "LASSO",
    "Collett’s Model Selection"
  ),
  Log_Lik = c(
    logLik(forward_model),
    logLik(forward_model_interact),
    logLik(backward_model),
    logLik(backward_model_interact),
    logLik(stepwise_model),
    logLik(stepwise_model_interact),
    logLik(lasso_model),
    logLik(colletts_model)
  ),
  AIC = c(
    AIC(forward_model),
    AIC(forward_model_interact),
    AIC(backward_model),
    AIC(backward_model_interact),
    AIC(stepwise_model),
    AIC(stepwise_model_interact),
    AIC(lasso_model),
    AIC(colletts_model)
  ),
  Kept_Variable = c(
    str_replace_all(paste(forward_model$formula[[3]][2]), " \\+", ","),
    str_replace_all(paste(forward_model_interact$formula[3]), " \\+", ","),
    str_replace_all(paste(formula(backward_model)[3]), " \\+", ","),
    str_replace_all(paste(formula(backward_model_interact)[3]), " \\+", ","),
    str_replace_all(paste(formula(stepwise_model)[3]), " \\+", ","),
    str_replace_all(paste(formula(stepwise_model_interact)[3]), " \\+", ","),
    str_replace_all(paste(formula(lasso_model)[3]), " \\+", ","),
    str_replace_all(paste(formula(colletts_model)[3]), " \\+", ",")
  )
)
model_comparison |>
  knitr::kable(caption = "Model Comparison") |>
  kable_styling(full_width = TRUE) |>
  column_spec(1, width = "2cm") |>
  column_spec(2, width = "2cm") |>
  column_spec(3, width = "2cm") |>
  column_spec(4, width = "7cm")
```

Among the models, backward and stepwise selection (AIC: 957.1105) and backward/stepwise selection with the interaction term (AIC: 957.0937) produced the lowest AIC values. Although the model with the interaction term had a slightly lower AIC (957.0937) compared to the simpler model (AIC: 957.1105), the difference was not substantial. The LASSO approach included additional variables such as ascites and spiders in the model. In contrast, Collett’s Model Selection retained far fewer variables but resulted in a significantly higher AIC of 965.2379. Based on the principle of parsimony, the simpler model was preferred to enhance interpretability and reduce the risk of overfitting. However, the final model selection will be revisited if further assessment, following the evaluation of the proportional hazards (PH) assumption, suggests a different approach is warranted.  
  
```{r stepwiseCox, echo=FALSE}
cirrhosis = read_csv("data/cirrhosis.csv")|> 
  janitor::clean_names() |>
  mutate(age = round(age / 365),
         sex = if_else(sex == "M", "Male", "Female"), 
         ascites = if_else(ascites == "N", "No", "Yes"), 
         hepatomegaly = if_else(hepatomegaly == "N", "No", "Yes"),
         spiders = if_else(spiders == "N", "No", "Yes"), 
         edema = if_else(edema == "N", "No", "Yes")) |> 
  na.omit()
cirrhosis = cirrhosis |> 
  mutate(
    status = case_when(
      status == "D" ~ 1,  # Event of interest (death)
      status == "C" | status == "CL" ~ 0,  # Censored data
      TRUE ~ as.numeric(status)), 
      stage = factor(stage)  # Convert 'stage' to a factor
)

# cox model based on stepwise selection varibales above (ixta)
cox_model_a = coxph(Surv(n_days, status) ~ drug + age + edema + 
                          bilirubin + albumin + copper + sgot +
                          prothrombin + stage, 
                    id=id,
                   data = cirrhosis)

# Summarize the results
cox_summary_a = tbl_regression(cox_model_a, exponentiate = TRUE) |> 
  modify_caption("Multivariate Cox Proportional Hazards Analysis - Stepwise Selection Model")
cox_summary_a |>
  kable(booktab = TRUE)%>%
  kable_styling(full_width = FALSE)
```

In Table \ref{tab:stepwiseCox}, we see the hazrd ratios, 95% confidence interval, and p-values for the model selected from stepwise selection. 

```{r stepwiseAssumptionPlots, echo=FALSE}
ph_assumption_a = cox.zph(cox_model_a)
par(mfrow = c(2, 3))  
plot(ph_assumption_a)
```

In Figure \ref{fig:stepwiseAssumptionPlots} we can see the hazard ratios over time. We see that the PH assumptions are violated. This is also seen in \ref{tab:stepwisePHTaable}. 
```{r stepwisePHTaable, echo=FALSE}
ph_assumption_df = as.data.frame(ph_assumption_a$table)
knitr::kable(ph_assumption_df, 
             booktabs = TRUE,
             caption = "Proportional Hazards Assumption Test for Cox PH Model - Stepwise Selection")%>%
  kable_styling(full_width = FALSE)
```

We can see from Table \ref{tab:stepwisePHTaable} that edema(p=0.013), bilirubin (p=0.003), and prothrombin (p=0.025) violate the PH assumptions. To reduce bias, stratification was conducted. 

```{r edemaStrataCox, echo=FALSE}
cox_model_edema_strat = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                                bilirubin + albumin + copper + sgot +
                                prothrombin + stage,
                                id = id,
                                data = cirrhosis)
# Summarize the results
cox_summary_b = tbl_regression(cox_model_edema_strat, exponentiate = TRUE) |> 
  modify_caption("Multivariate Cox Proportional Hazards Analysis - Stratification  of Edema Model")
cox_summary_b |>
  kable(booktab = TRUE)%>%
  kable_styling(full_width = FALSE)
```
In Table \ref{tab:edemaStrataCox}, we see the hazrd ratios, 95% confidence interval, and p-values for the model after stratifcation of edema. 

```{r PHStrataEdemaPlots, echo=FALSE}
ph_assumption_b = cox.zph(cox_model_edema_strat)
par(mfrow = c(2, 3)) 
plot(ph_assumption_a)
```

We can see the from Figure \ref{fig:PHStrataEdemaPlots} that there are slight improves to the covariates that were initially were violations. 

```{r PHStrataEdema, echo=FALSE}
ph_assumption_edema_strat = cox.zph(cox_model_edema_strat) 
ph_assumption_edema = as.data.frame(ph_assumption_edema_strat$table)
knitr::kable(ph_assumption_edema, 
             booktabs = TRUE,
             caption = "Proportional Hazards Assumption Test COX PH Model Stratified for Edema")%>%
  kable_styling(full_width = FALSE)
```

In Table \ref{tab:PHStrataEdema}, after the stratification of edema, bilirubin (p=0.0006) is the only variable violating PH assumptions. A time interaction is added to bilirubin to make the model appropriate. 

Now, interaction terms are considered between the covariates in the model. During the first iteration, five interaction terms, including interaction for Copper with age, Albumin, SGOT, Prothrombin, and diease stage are selected using criteria $p<0.05$, and the interaction between Albumin and Copper is added to the model as it has the lowest p value. During the second iteration, none of the interaction terms gets selected, and the iteration ends. The final model can then be specified as:

$$
\begin{aligned}
 log(\text{HR}) =&\beta_1I(\text{drug=D-penicillamine})+\beta_2age+\beta_3\text{billirubin}+\beta_4\text{albumin}+\beta_5\text{copper}\\
 &+\beta_6\text{sgot}+\beta_7\text{prothrombin}+\beta_8I(\text{stage=2})+\beta_9I(\text{stage=3})+\beta_{10}I(\text{stage=4})\\
 &+\beta_{11}\text{bilirubin}:\text{n\_days}+\beta_{12}\text{albumin}:\text{copper}
\end{aligned}
$$

Table \ref{tab:evalfinal} shows the model estimates. It can be concluded that, holding other covariates constant:

 - The primary variable of interest, drug, has a negative yet insignificant impact on survival. Other covariates that impose a negative significant impact include age, Bilirubin, SGOT, Prothrombin, Stage 4 (compared with Stage 1), and interaction between Albumin and Copper. Albumin, Copper, and interaction between Bilirubin and number of days instead have a protective significant impact.
 - The hazard for PBC patients treated with D-penicillamine is 1.2720 times that of PBC patients treated with Placebo.
 - The hazard ratio for PBC patients with one year increase in age is  1.0343.
 - The hazard ratio for PBC patients with 1 mg/dl increase in Bilirubin is 1.2798.
 - The hazard ratio for PBC patients with 1 gm/dl increase in Albumin is 0.2316.
 - The hazard ratio for PBC patients with 1 ug/day increase in Copper is 0.9779.
 - The hazard ratio for PBC patients with 1U/ml in SGOT is 1.0065.
 - The hazard ratio for PBC patients with 1s increase in Prothrombin is 1.3257.
 - The hazard for PBC patients at Stage 2, 3, and, 4 is 3.7034, 5.4604, and 8.0139 times that of PBC patients at Stage 1.
 - For the same level of Bilirubin, a unit increase in survive time results in $-0.0002\text{Bilirubin}$ change in the effect of Bilirubin on log hazard ratio for PBC patients.
 - For the same level of Albumin, a unit increase in Copper results in $0.0076\text{Albumin}$ change in the effect of Albumin on log hazard ratio for PBC patients.
 
```{r warning=FALSE, echo=FALSE, message=FALSE}
cirrhosis = read_csv("../data/cirrhosis.csv")|> 
  janitor::clean_names() |>
  mutate(age = round(age / 365),
         sex = if_else(sex == "M", "Male", "Female"), 
         ascites = if_else(ascites == "N", "No", "Yes"), 
         hepatomegaly = if_else(hepatomegaly == "N", "No", "Yes"),
         spiders = if_else(spiders == "N", "No", "Yes"), 
         edema = if_else(edema == "N", "No", "Yes"),
         stage = factor(stage),
         drug = factor(drug, levels = c("Placebo", "D-penicillamine"), order = T)) |> 
  na.omit()
cirrhosis = cirrhosis |> 
  mutate(
    status = case_when(
      status == "D" ~ 1,  # Event of interest (death)
      status == "C" | status == "CL" ~ 0,  # Censored data
      TRUE ~ as.numeric(status)))

# Interaction between Convariates
cox_init = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                                bilirubin + albumin + copper + sgot +
                                prothrombin + stage + bilirubin : n_days, 
                         id = id, 
                        data = cirrhosis |> na.omit())
variables = c("drug", "age", "albumin", "copper", "sgot",
              "prothrombin", "stage")
vars_df = tibble()
for(var in variables[1 : (length(variables) - 1)])
{
  left_vars = variables[(which(variables == var) + 1) : length(variables)]
  for(var2 in left_vars)
  {
    cox_fit = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                                bilirubin + albumin + copper + sgot +
                                prothrombin + stage + bilirubin : n_days +
                      eval(parse(text = var2)) : eval(parse(text = var)), 
                         id = id, 
                        data = cirrhosis |> na.omit())
     # aic_vec= c(aic_vec, AIC(model_four))
     chisq_stat=-2 * (logLik(cox_init)-logLik(cox_fit))
     p_val = 1 - pchisq(chisq_stat,
                        attr(logLik(cox_fit), "df") - 
                          attr(logLik(cox_init),"df"))
     if(p_val < 0.05)
     {
       vars_df = vars_df |> rbind(c(round(p_val, 4), var, var2))
     }
  }
}

colnames(vars_df) = c("p_value", "variable1", "variable2")
# vars_df |> 
#   mutate(interaction = paste0(variable1, " * ", variable2)) |> 
#   select(interaction, p_value) |> 
#   knitr::kable(col.names = c("Interaction Term", "P Value"),
#     caption = "Siginificant Interaction term")

# We first add the albumin*copper term into the model and evaluate again.

cox_fit2 = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                   bilirubin + albumin + copper + sgot + prothrombin + stage +
                   bilirubin : n_days + albumin * copper, 
                 id = id, data = cirrhosis)
vars_df = tibble()
for(var in variables[1 : (length(variables) - 1)])
{
  left_vars = variables[(which(variables == var) + 1) : length(variables)]
  for(var2 in left_vars)
  {
    cox_fit = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                      bilirubin + albumin + copper + sgot + prothrombin + 
                      stage + bilirubin : n_days + albumin * copper +
                      eval(parse(text = var2)) : eval(parse(text = var)), 
                         id = id, 
                        data = cirrhosis)
     # aic_vec= c(aic_vec, AIC(model_four))
     chisq_stat=-2 * (logLik(cox_fit2)-logLik(cox_fit))
     p_val = 1 - pchisq(chisq_stat,
                        attr(logLik(cox_fit), "df") - 
                          attr(logLik(cox_fit2),"df"))
     if(p_val < 0.05)
     {
       vars_df = vars_df |> rbind(c(round(p_val, 4), var, var2))
     }
  }
}

# This is our final model.
cox_final = cox_fit2
# summary(cox_final)$coefficient %>% .[, c(1, 2, 5)] |>
#   data.frame() |> mutate(significance = c("", "**", "***", "***", "**", "***", "*",
#                                           "", "", "*", "***", "***")) |> 
#   knitr::kable(col.names = c(" ", "Estimate", "Hazard Ratio", "p value", "Sig."), 
#                digits = 4, caption = "Final Model Parameter Results")
```

```{r evalfinal, warning=FALSE, echo=FALSE}
cox_final |> tbl_regression(
  exponentiate = T,
  estimate_fun = purrr::partial(style_ratio, digits = 4),
  pvalue_fun = purrr::partial(style_sigfig, digits = 4)) |> 
  modify_caption("Final Model Hazard Ratio Estimates")
```

Model evaluation is then conducted on this final model. Figures \ref{fig:deviance} and \ref{fig:coxsnell} show the deviance residuals distribution and the KM estimates using Cox-Snell residuals as pseudo survival time respectively. As there is no obvious trend in the deviance plots and the line is close to the reference line in Cox-Snell plot, it can be concluded that the model is a relatively good fit.

```{r deviance, warning=FALSE, echo=FALSE, fig.width=8,fig.height=6, fig.cap="\\label{fig:deviance}Deviance Residuals Scatterplot for Individual Variable", fig.align='center'}
deviance_res = residuals(cox_final, type = "deviance", var = stage)

dev_drug = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = drug, y = deviance)) +
  geom_point()
dev_age = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = age, y = deviance)) +
  geom_point()
dev_bili = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = bilirubin, y = deviance)) +
  geom_point()
dev_albu = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = albumin, y = deviance)) +
  geom_point()
dev_copper = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = copper, y = deviance)) +
  geom_point()
dev_sgot = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = sgot, y = deviance)) +
  geom_point()
dev_proth = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = prothrombin, y = deviance)) +
  geom_point()
dev_stage = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = stage, y = deviance)) +
  geom_point()

ggarrange(dev_drug, dev_age, dev_bili, dev_albu, dev_copper, 
          dev_sgot, dev_proth, dev_stage, ncol = 4, nrow = 2)

# plot(deviance_res, ylab = "Deviance Residuals", xlab = "Index",
#      main = "Deviance Residuals Scatterplot")
# abline(h = c(-3, 3), col = "red", lty = 2) # Flag large residuals
# which(deviance_res > 3)
```

```{r coxsnell, warning=FALSE, echo=F, fig.width=5, fig.height=3, fig.cap="KM Estimates Using Cox-Snell Residuals", fig.align='center'}
coxsnell_res = - (predict(cox_final, type = "survival") |> log())
# hist(coxsnell_res, main = "Cox-Snell Residuals Histogram", freq = F, breaks = 15)
# curve(exp(- x), add = T, col = "red")
# plot(coxsnell_res, ylab = "Cox-Snell Residuals", xlab = "Index",
#      main = "Cox-Snell Residuals Scatterplot")
km_fit = cirrhosis |> mutate(pseudo_time = coxsnell_res) |> 
  survfit(Surv(pseudo_time, status) ~ 1, id = id, data = _)
km_summary = summary(km_fit)
tibble(
  t = km_summary$time,
  survival = km_summary$surv
) |> 
  mutate(y = log(- log(survival))) |> 
  ggplot(aes(x = log(t), y = y)) +
  geom_line() +
  geom_abline(intercept = 0, slope = 1, color = "red", lty = 2) +
  labs(y = "log(-log(S(t)))", title = "")
```


```{r, warning=FALSE, echo=FALSE, fig.width=8, fig.height=6}
ld_res = c()
for(i in 1 : nrow(cirrhosis))
{
  dat = cirrhosis |> slice(- i)
  model_ld = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                   bilirubin + albumin + copper + sgot + prothrombin + stage +
                   bilirubin : n_days + albumin * copper, 
                 id = id, data = dat)
  ld_res = c(ld_res, 2 * abs(logLik(model_ld) - logLik(cox_final)))
}
```

For influence diagnostics, the individuals that provide the 5 largest absolute differences for the LD option are selected. After removing the outliers (identified by a deviance residual larger than 3, 2 are selected) and the 5 influential individuals, the model is re-fit. Table \ref{tab:evalcomparison} compares the model estimates for the two models. There are subtle differences between model estimates, but the direction of impact stays the same for all the variables, thus resulting in similar conclusions.

```{r evalcomparison, warning=F, echo=FALSE}
cox_after = cirrhosis |> 
  slice(c(- 77, - 143, - 82, - 100, - 108, - 129, - 210)) |> 
  coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                   bilirubin + albumin + copper + sgot + prothrombin + stage +
                   bilirubin : n_days + albumin * copper, 
                 id = id, data = _)
summary(cox_final)$coefficient %>% .[, c(1, 2, 5)] |>
  cbind(summary(cox_after)$coefficient %>% .[, c(1, 2, 5)]) |> 
  knitr::kable(col.names = c(" ", rep(c("Estimate", "Hazard Ratio", "p value"), 2)), 
               digits = 4, caption = "Model Parameter Estimates Comparison") |> 
  add_header_above(header = c(" " = 1, "Original Model" = 3, "New Model" = 3))
```

# Discussion

The analysis demonstrates that D-penicillamine is inefficient in improving survival outcomes for patients with primary biliary cirrhosis (PBC). The hazard ratio for those treated with the drug is 1.2720 compared to placebo, indicating no survival benefit and a potential negative effect. This finding suggests the need to reconsider its use and focus on alternative therapies that may offer greater efficacy.

Kaplan-Meier analysis further confirmed the inefficacy of D-penicillamine, as survival probabilities between the drug and placebo groups showed no statistically significant difference. The overlapping survival curves reinforce the finding that D-penicillamine does not confer a survival advantage and may require reevaluation as a treatment option. Additionally, Kaplan-Meier analysis highlighted the importance of edema, as patients without edema showed significantly better survival probabilities, making it a critical factor in risk stratification.

Age and disease stage emerged as critical determinants of survival, underscoring the importance of early detection and stage-specific care. The hazard of mortality increases significantly with each advancing stage, with Stage 4 patients facing an eightfold higher risk compared to Stage 1. Kaplan-Meier survival curves demonstrated markedly reduced survival probabilities in advanced stages, with a sharp decline observed in stages 3 and 4. Early interventions to halt disease progression are vital, as is tailoring treatment strategies to the patient's disease stage.

Liver function indicators such as Bilirubin, Copper, SGOT, Prothrombin, and Albumin are vital in survival outcomes. Elevated Bilirubin, SGOT, and Prothrombin levels are associated with higher hazards, reflecting liver damage and dysfunction. Conversely, higher albumin levels provide a strong protective effect, emphasizing the importance of maintaining good nutritional and synthetic liver function. The modest protective impact of Copper is proved by previous studies where Copper deficiency is identified as a risk factor for mortality in advanced liver disease [@yu2019copper]. These findings highlight the necessity of monitoring liver function and metabolic health closely to identify high-risk patients and address reversible factors.

The analysis also revealed key interactions affecting survival. A negative Albumin-Copper interaction was observed, indicating a synergistic detrimental effect. This underscores the complexity of metabolic interactions in liver disease and the need to address deficiencies or toxicities in a balanced manner. Furthermore, continued investigation of other potential interactions is needed to uncover personalized treatment strategies.

To improve patient outcomes, it is crucial to monitor high-risk patients routinely, focusing on those with poor liver function indicators or advanced disease stages. Additionally, conducting biological investigations into the protective role of copper and its interactions with other variables could provide valuable insights. These efforts can pave the way for personalized therapies that address the unique risk profiles of individual patients and enhance survival outcomes.

There were several limitations within the project including missing data, imbalanced data, and a high censoring rate. Regarding missing data, 147 observation had missing values, which may require the application of imputations techniques to address potential bias. Furthermore, the data imbalance was attributed to the distribution of sex, where we had about 80-90% female participants and the right-skwedness of bilirubin. Lastly, with more than 50% of data being censored, high censoring data was a major limitation on the survival analysis and the robustness of the results. 

# Conclusion

\newpage

# References

<div id="refs"></div>

\newpage

# Appendix 

## Code

\begingroup
\setstretch{1}

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}

```

\endgroup
