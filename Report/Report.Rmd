---
title: "Cirrhosis Patient Survival Prediction"
author: Chen Liang, Jessie Li, Xinyi Shang, Ixtaccihuatl Obregon, Jane Ma
date: ""
output: pdf_document
fontsize: 12pt
linestretch: 1.5
bibliography: references.bib
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, out.width = "80%", fig.align = "center")
options(knitr.kable.NA = '')
library(tidyverse)
library(RColorBrewer)
library(corrplot)
library(gtsummary)
library(flextable)
library(stringr)
library(survival)
library(survminer)
library(kableExtra)
library(ggplot2)
library(ggpubr)
library(gridExtra)

write_matex <- function(x) {
  begin <- "$$\\begin{bmatrix}"
  end <- "\\end{bmatrix}$$"
  X <-
    apply(x, 1, function(x) {
      paste(
        paste(x, collapse = "&"),
        "\\\\"
      )
    })
  writeLines(c(begin, X, end))
}
theme_set(
  theme_bw()+
  theme(
    plot.title = element_text(size = 16, hjust = 0.5),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 10),
    axis.line = element_line(color = "black", size = 0.5),
  )
)
```

# Background

## Cirrhosis Overview

## Related research

## Study Objective

# Methods

## Dataset Description

The dataset used in this analysis originates from a study on primary biliary cirrhosis (PBC) conducted at the Mayo Clinic. It contains data for 276 patients, each characterized by 20 variables reflecting demographic, clinical, and laboratory features. Demographic variables include age and sex. Clinical features include the presence or absence of ascites, hepatomegaly, spiders, and edema, as well as the histologic stage of the disease. Laboratory markers, such as bilirubin, albumin, copper, alkaline phosphatase (alk_phos), SGOT, triglycerides, platelets, and prothrombin time, provide insight into liver function and disease severity. Outcome measures include the number of days from registration to death, liver transplantation, or censoring, and patient status (D: death, C: censored, CL: censored due to liver transplantation). The dataset underwent transformations to clean column names, adjust age to years, and harmonize categorical variables for consistency.

Missing data were handled by removing rows with incomplete values. Out of the original dataset, 142 entries were removed due to missing information, resulting in a final dataset of 276 complete cases. This approach ensures the integrity of statistical analysis by avoiding imputation biases. By excluding records with missing data, the analysis avoids biases introduced by imputation but acknowledges the trade-off between sample size and data quality.

As shown in Table 1, the baseline characteristics of patients reveal significant differences across survival outcomes. Patients who died had the shortest survival time, highest bilirubin, alkaline phosphatase, and SGOT levels, as well as the most advanced disease stage (50% in stage 4). In contrast, younger patients were more likely to undergo liver transplantation, with a mean age of 40.7 years compared to 53.4 years in the death group. Clinical features such as ascites, hepatomegaly, and edema were more prevalent among those who died or underwent transplantation, indicating disease severity. Additionally, lower albumin levels and prolonged prothrombin time in the death group highlight impaired liver function as a key prognostic factor.

```{r}
cirrhosis <- read_csv("data/cirrhosis.csv")|> 
  janitor::clean_names() |>
  mutate(age = round(age / 365),
         sex = if_else(sex == "M", "Male", "Female"), 
         ascites = if_else(ascites == "N", "No", "Yes"), 
         hepatomegaly = if_else(hepatomegaly == "N", "No", "Yes"),
         spiders = if_else(spiders == "N", "No", "Yes"), 
         edema = if_else(edema == "N", "No", "Yes"))|>
  na.omit()
```

```{r, out.width="80%", out.height="80%", warning=FALSE}
theme_gtsummary_journal(journal = "nejm")

cirrhosis_df <- cirrhosis |> 
  mutate(
    status = case_when(
      status == "C" ~ "Censored",
      status == "CL" ~ "Censored due to liver tx",
      status == "D" ~ "Death",
      TRUE ~ status))

table_1 <- cirrhosis_df |>
  select(-id) |> 
  tbl_summary(
    by = status,
    statistic = list(
      all_continuous() ~ "{mean} / {median} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    digits = all_continuous() ~ 1,
    missing = "no",
    label = list(
    n_days ~ "N_days",
    drug ~ "Drug",
    age ~ "Age",
    sex ~ "Sex",
    ascites ~ "Ascites",
    hepatomegaly ~ "Hepatomegaly",
    spiders ~ "Spiders",
    edema ~ "Edema",
    bilirubin ~ "Bilirubin",
    cholesterol ~ "Cholesterol",
    albumin ~ "Albumin",
    copper ~ "Copper",
    alk_phos ~ "Alk_phos",
    sgot ~ "SGOT",
    tryglicerides ~ "Tryglicerides",
    platelets ~ "Platelets",
    prothrombin ~ "Prothrombin",
    stage ~ "Stage"
  )) |>
  modify_caption("Baseline Characteristics") |> 
  as_flex_table() |> 
  set_table_properties(width = 0.8, layout = "autofit") # Set width to 80%
  
table_1
```
 
## Survival Analysis

### Kaplan-Meier Estimates

### Log-Rank Test

### Cox PH
(Feature selection, model assumptions, model evaluation)

After the proportional hazards assumption is met, interaction terms between model covariates are considered using the likelihood ratio test. Suppose there are $p$ covariates in the model. First, each one of the $\frac{p(p-1)}{2}$ interaction terms is added to the model to obtain $\frac{p(p-1)}{2}$ $p$ value, and the interaction term with the lowest $p$ value is added to the model. Then, the rest of the interaction terms are added to the new model one by one to obtain the $p$ value. The process is repeated until $p>0.05$ holds for all the likelihood ratio tests. The model with the added interaction terms is the final model.

With the final model, model evaluation is conducted. Deviance residuals and Cox-Snell residuals are used to evaluate model fit. For models with good fit, deviance residuals should be randomly distributed around 0, and for KM survival estimates using Cox-Snell residuals as the pseudo survival time, $log(-log(S(t)))$ should be approximately equal to $log(t)$. Influence diagnostics with LD option is used to identify influential individuals. It evaluates how much the log-likelihood would change if the $i^{th}$ person was removed from the sample. After identifying outliers and influential individuals, these subjects are removed from the sample and the model is re-fit to see if the results would change.

# Results

## Descriptive Statistics (EDA)

Figure 1 provides insights into the distributions of continuous variables through boxplots, revealing heterogeneity in liver disease severity. Variables such as bilirubin, alkaline phosphatase, SGOT, and prothrombin exhibit highly skewed distributions with significant outliers, reflecting the heterogeneity in liver disease severity among patients. These patterns highlight the diversity in clinical markers and their potential implications for survival outcomes.
```{r fig.cap="Boxplots for Continuous Variables"}
conti_vars = cirrhosis |>
  select(age, bilirubin, cholesterol, albumin, copper, alk_phos, sgot, tryglicerides, platelets,prothrombin)

# Boxplot for all continuous variables
par(mfrow = c(2, 5), oma = c(2, 2, 3, 1), mar = c(4, 4, 2, 1))
conti_names <- names(conti_vars)

p1 <- for (i in seq_along(conti_names)) {
  boxplot(conti_vars[[conti_names[i]]],
          main = conti_names[i],
          ylab = "Value",
          col = "lightblue",
          outline = TRUE)  # Show outliers
}
```

As shown in the Figure 2, the majority of patients are female, lack ascites, and are evenly distributed regarding hepatomegaly. Most are in stages 2 and 3 of the disease, with a notable proportion in stage 4, indicating disease progression. Drug distribution is balanced between D-penicillamine and placebo groups, supporting comparability in treatment outcomes.
```{r fig.cap="Barplots for Categorical Variables"}
cate_vars = cirrhosis |>
  select(drug, sex, ascites, hepatomegaly, spiders, edema, stage)

par(mfrow = c(2, 4),  # 2 rows, 5 columns
    oma = c(2, 2, 3, 1),  # Outer margins
    mar = c(4, 4, 2, 1),  # Inner margins for individual plots
    mgp = c(2, 1, 0))     # Margins for axis labels and titles

colors <- c(brewer.pal(9, "YlGnBu"), "darkblue") 

barplot(table(cate_vars$drug), main = "Drug", ylab = "Count",col = colors[1])
barplot(table(cate_vars$sex), main = "Sex", ylab = "Count",col = colors[2])
barplot(table(cate_vars$ascites), main = "Ascites", ylab = "Count", col = colors[3])
barplot(table(cate_vars$hepatomegaly), main = "Hepatomegaly", ylab = "Count", col = colors[4])
barplot(table(cate_vars$spiders), main = "Spiders", ylab = "Count", col = colors[5])
barplot(table(cate_vars$edema), main = "Edema", ylab = "Count", col = colors[6])
barplot(table(cate_vars$stage), main = "Stage", ylab = "Count", col = colors[7])
```

Finally, Figure 3 presents the correlation matrix, which highlights strong positive associations between bilirubin, alkaline phosphatase, and SGOT, emphasizing their relationship with liver dysfunction. In contrast, albumin and platelet counts negatively correlate with disease stage, indicating their decline as the disease advances. These relationships highlight key biomarkers of cirrhosis progression.
```{r fig.cap="Correlation Matrix"}
numeric_cirr <- cirrhosis |>
  select_if(is.numeric)

cor_matrix <- cor(numeric_cirr, use = "complete.obs")

corrplot(cor_matrix, method = "circle", type = "lower", order = "hclust")
```
## KM and Log-Rank Test

```{r echo = FALSE, message = F, warning = F}
cirrhosis <- read_csv("../data/cirrhosis.csv")|> 
  janitor::clean_names() |>
  mutate(age = round(age / 365),
         sex = if_else(sex == "M", "Male", "Female"), 
         ascites = if_else(ascites == "N", "No", "Yes"), 
         hepatomegaly = if_else(hepatomegaly == "N", "No", "Yes"),
         spiders = if_else(spiders == "N", "No", "Yes"), 
         edema = if_else(edema == "N", "No", "Yes")) |>
  drop_na()


cirrhosis$event <- ifelse(cirrhosis$status == "D", 1, 0)

surv_object <- Surv(time = cirrhosis$n_days, event = cirrhosis$event)

km_fit <- survfit(surv_object ~ 1, data = cirrhosis)

plot_all = ggsurvplot(km_fit, conf.int = TRUE, 
           title = "(a) Overall",
           xlab = "Days", ylab = "Survival Probability",
           legend.title = "",
           ggtheme = theme_minimal())

```

```{r echo = FALSE, message = F, warning = F}
km_fit_drug <- survfit(surv_object ~ drug, data = cirrhosis)

plot_drug = ggsurvplot(km_fit_drug, conf.int = TRUE, 
           title = "(b) Drug Type",
           xlab = "Days", ylab = "Survival Probability",
           legend.title = "",
           ggtheme = theme_minimal() )

```

```{r survivalcurveKM, echo=FALSE, message = F, warning  = F, fig.cap="Kaplan-Meier Survival Curve"}

# Fit survival curves by edema
km_fit_edema <- survfit(surv_object ~ edema, data = cirrhosis)
plot_edema <- ggsurvplot(
  km_fit_edema, conf.int = TRUE, 
  title = "(a) Edema",
  xlab = "Days", ylab = "Survival Probability",
  legend.title = "",
  ggtheme = theme_minimal() 
)

# Fit survival curves by stage
km_fit_stage <- survfit(surv_object ~ stage, data = cirrhosis)
plot_stage <- ggsurvplot(
  km_fit_stage, conf.int = TRUE, 
  title = "(b) Stage",
  xlab = "Days", ylab = "Survival Probability",
  legend.title = "",
  ggtheme = theme_minimal()
)

# Arrange the plots side by side with adjusted spacing
grid.arrange(
  plot_all$plot,
  plot_drug$plot,
  plot_edema$plot, 
  plot_stage$plot, 
  ncol = 2, 
  widths = c(1, 1) # Equal sizing for both plots
)

```

```{r echo = FALSE, message = F, warning = F}
max_time <- max(cirrhosis$n_days, na.rm = TRUE)
max_years <- floor(max_time / 365)
yearly_times <- seq(0, max_years * 365, by = 365)

km_summary_yearly <- summary(km_fit, times = yearly_times)

# Create the data frame from the KM summary
surv_yearly_table <- data.frame(
  years = yearly_times / 365,
  n_risk = km_summary_yearly$n.risk,
  n_event = km_summary_yearly$n.event,
  n_censor = km_summary_yearly$n.censor,
  survival = km_summary_yearly$surv,
  lower_ci = km_summary_yearly$lower,
  upper_ci = km_summary_yearly$upper
)

# If time=0 row does not exist, add it
if (!any(yearly_times == 0)) {
  surv_yearly_table <- rbind(
    data.frame(
      years = 0,
      n_risk = km_fit$n.risk[1],
      n_event = 0,
      n_censor = 0,
      survival = 1,
      lower_ci = 1,
      upper_ci = 1
    ),
    surv_yearly_table
  )
}

surv_yearly_table <- surv_yearly_table[order(surv_yearly_table$years), ]

interval_labels <- sapply(2:nrow(surv_yearly_table), function(i) {
  paste0("[", surv_yearly_table$years[i-1], ", ", surv_yearly_table$years[i], ")")
  })

surv_yearly_intervals <- surv_yearly_table[-1, ] # Remove the first row if needed

surv_yearly_intervals$interval <- interval_labels

surv_yearly_intervals$n_risk[1] <- surv_yearly_table$n_risk[1]
  
for (i in 2:nrow(surv_yearly_intervals)) {
  surv_yearly_intervals$n_risk[i] <- surv_yearly_intervals$n_risk[i-1] - 
                                       surv_yearly_intervals$n_event[i-1] - 
                                       surv_yearly_intervals$n_censor[i-1]
}

surv_table = surv_yearly_intervals %>%
  rownames_to_column() %>%         # Convert any existing row names to a column
  select(-rowname) %>%             # Remove the converted row names column
  select(interval, n_risk, n_event, n_censor, survival, lower_ci, upper_ci)|>
  as.data.frame()
```

```{r lifetable, echo = FALSE, message = F, warning = F}
kable(
  surv_table, 
  caption = "Kaplan-Meier Survival Summary in Years",
      col.names = c("Time Interval (Years)", "At Risk", "Events", "Censored", "Survival Probability", "Lower CI", "Upper CI"),
  digits = 2,
  booktabs = TRUE
) 
```


The Kaplan-Meier survival analysis provides valuable insights into overall survival probabilities over time. The survival curve shows a consistent decline in survival probability Figure \ref{fig:survivalcurveKM} (a), with a median survival probability of 9 years and a 75% survival probability of 4 years. Key survival probabilities at yearly intervals are summarized in Table \ref{tab:lifetable}.

```{r logrankKM, echo = FALSE, message = F, warning = F}
log_rank_test <- survdiff(surv_object ~ drug, data = cirrhosis)

log_rank_results_drug <- data.frame(
  Group = "Drug",
  Statistic = log_rank_test$chisq,
  Degrees_of_Freedom = 1,
  P_Value = log_rank_test$pvalue
) 

log_rank_results_drug[, -1] <- log_rank_results_drug[, -1] %>%
  mutate(across(where(is.numeric), ~ round(., 4)))


# Log-rank test for edema
log_rank_test_edema <- survdiff(surv_object ~ edema, data = cirrhosis)
log_rank_results_edema <- data.frame(
  Group = "Edema",
  Statistic = log_rank_test_edema$chisq,
  Degrees_of_Freedom = 1,
  P_Value = ifelse(log_rank_test_edema$pvalue < 0.0001, "<0.0001", log_rank_test_edema$pvalue)
)

# Log-rank test for stage
log_rank_test_stage <- survdiff(surv_object ~ stage, data = cirrhosis)
log_rank_results_stage <- data.frame(
  Group = "Stage",
  Statistic = log_rank_test_stage$chisq,
  Degrees_of_Freedom = 3,
  P_Value = ifelse(log_rank_test_stage$pvalue < 0.0001, "<0.0001", log_rank_test_stage$pvalue)
)

log_rank_results_combined <- rbind(log_rank_results_drug,
                                   log_rank_results_edema, 
                                   log_rank_results_stage)

kable(
  log_rank_results_combined[, -1], # Exclude the "Group" column for main table
  digits = 4,
  col.names = c("Chi-Squared Statistic", "Degrees of Freedom", "P-Value"),
  caption = "Log-Rank Test Results"
) %>%
  pack_rows("Drug", 1, 1) |>
  pack_rows("Edema", 2, 2) |>
  pack_rows("Stage", 3, 3)     
```

A comparison of survival probabilities between the two treatment groups—D-penicillamine and placebo—demonstrated no statistically significant differences. The log-rank test produced a p-value of 0.5246, far above the significance threshold of 0.05. The Kaplan-Meier curves for these groups overlap substantially, indicating that D-penicillamine does not significantly improve survival outcomes compared to placebo (Table \ref{tab:logrankKM}, Figure \ref{fig:survivalcurveKM} (b)).

Edema shows as a critical factor influencing survival, as highlighted by the log-rank test (p-value < 0.0001). Patients without edema exhibit significantly better survival probabilities than those with edema (Table \ref{tab:logrankKM}, Figure \ref{fig:survivalcurveKM} (c)). The stark contrast in survival curves underscores edema as a key predictor of survival and its importance in risk stratification.

The histologic stage of the disease also plays a significant role in survival outcomes. The log-rank test for stage groups yielded a highly significant p-value (< 0.0001), indicating marked differences in survival curves across stages (Table \ref{tab:logrankKM}, Figure \ref{fig:survivalcurveKM} (d)). Patients in advanced stages (3 and 4) have substantially lower survival probabilities compared to those in earlier stages (1 and 2).

## Cox Model
(Feature selection, model assumptions, model evaluation)

Now, interaction terms are considered between the covariates in the model. During the first iteration, five interaction terms, including interaction for Copper with age, Albumin, SGOT, Prothrombin, and diease stage are selected using criteria $p<0.05$, and the interaction between Albumin and Copper is added to the model as it has the lowest p value. During the second iteration, none of the interaction terms gets selected, and the iteration ends. The final model can then be specified as:
$$
\begin{aligned}
 log(\text{HR}) =&\beta_1I(\text{drug=D-penicillamine})+\beta_2age+\beta_3\text{billirubin}+\beta_4\text{albumin}+\beta_5\text{copper}\\
 &+\beta_6\text{sgot}+\beta_7\text{prothrombin}+\beta_8I(\text{stage=2})+\beta_9I(\text{stage=3})+\beta_{10}I(\text{stage=4})\\
 &+\beta_{11}\text{bilirubin}:\text{n\_days}+\beta_{12}\text{albumin}:\text{copper}
\end{aligned}
$$

Table \ref{tab:evalfinal} shows the model estimates. It can be concluded that, holding other covariates constant:

 - The primary variable of interest, drug, has a negative yet insignificant impact on survival. Other covariates that impose a negative significant impact include age, Bilirubin, SGOT, Prothrombin, Stage 4 (compared with Stage 1), and interaction between Albumin and Copper. Albumin, Copper, and interaction between Bilirubin and number of days instead have a protective significant impact.
 - The hazard for PBC patients treated with D-penicillamine is 1.2720 times that of PBC patients treated with Placebo.
 - The hazard ratio for PBC patients with one year increase in age is  1.0343.
 - The hazard ratio for PBC patients with 1 mg/dl increase in Bilirubin is 1.2798.
 - The hazard ratio for PBC patients with 1 gm/dl increase in Albumin is 0.2316.
 - The hazard ratio for PBC patients with 1 ug/day increase in Copper is 0.9779.
 - The hazard ratio for PBC patients with 1U/ml in SGOT is 1.0065.
 - The hazard ratio for PBC patients with 1s increase in Prothrombin is 1.3257.
 - The hazard for PBC patients at Stage 2, 3, and, 4 is 3.7034, 5.4604, and 8.0139 times that of PBC patients at Stage 1.
 - For the same level of Bilirubin, a unit increase in survive time results in $-0.0002\text{Bilirubin}$ change in the effect of Bilirubin on log hazard ratio for PBC patients.
 - For the same level of Albumin, a unit increase in Copper results in $0.0076\text{Albumin}$ change in the effect of Albumin on log hazard ratio for PBC patients.
 
```{r warning=FALSE, echo=FALSE, message=FALSE}
cirrhosis = read_csv("../data/cirrhosis.csv")|> 
  janitor::clean_names() |>
  mutate(age = round(age / 365),
         sex = if_else(sex == "M", "Male", "Female"), 
         ascites = if_else(ascites == "N", "No", "Yes"), 
         hepatomegaly = if_else(hepatomegaly == "N", "No", "Yes"),
         spiders = if_else(spiders == "N", "No", "Yes"), 
         edema = if_else(edema == "N", "No", "Yes"),
         stage = factor(stage),
         drug = factor(drug, levels = c("Placebo", "D-penicillamine"), order = T)) |> 
  na.omit()
cirrhosis = cirrhosis |> 
  mutate(
    status = case_when(
      status == "D" ~ 1,  # Event of interest (death)
      status == "C" | status == "CL" ~ 0,  # Censored data
      TRUE ~ as.numeric(status)))

# Interaction between Convariates
cox_init = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                                bilirubin + albumin + copper + sgot +
                                prothrombin + stage + bilirubin : n_days, 
                         id = id, 
                        data = cirrhosis |> na.omit())
variables = c("drug", "age", "albumin", "copper", "sgot",
              "prothrombin", "stage")
vars_df = tibble()
for(var in variables[1 : (length(variables) - 1)])
{
  left_vars = variables[(which(variables == var) + 1) : length(variables)]
  for(var2 in left_vars)
  {
    cox_fit = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                                bilirubin + albumin + copper + sgot +
                                prothrombin + stage + bilirubin : n_days +
                      eval(parse(text = var2)) : eval(parse(text = var)), 
                         id = id, 
                        data = cirrhosis |> na.omit())
     # aic_vec= c(aic_vec, AIC(model_four))
     chisq_stat=-2 * (logLik(cox_init)-logLik(cox_fit))
     p_val = 1 - pchisq(chisq_stat,
                        attr(logLik(cox_fit), "df") - 
                          attr(logLik(cox_init),"df"))
     if(p_val < 0.05)
     {
       vars_df = vars_df |> rbind(c(round(p_val, 4), var, var2))
     }
  }
}

colnames(vars_df) = c("p_value", "variable1", "variable2")
# vars_df |> 
#   mutate(interaction = paste0(variable1, " * ", variable2)) |> 
#   select(interaction, p_value) |> 
#   knitr::kable(col.names = c("Interaction Term", "P Value"),
#     caption = "Siginificant Interaction term")

# We first add the albumin*copper term into the model and evaluate again.

cox_fit2 = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                   bilirubin + albumin + copper + sgot + prothrombin + stage +
                   bilirubin : n_days + albumin * copper, 
                 id = id, data = cirrhosis)
vars_df = tibble()
for(var in variables[1 : (length(variables) - 1)])
{
  left_vars = variables[(which(variables == var) + 1) : length(variables)]
  for(var2 in left_vars)
  {
    cox_fit = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                      bilirubin + albumin + copper + sgot + prothrombin + 
                      stage + bilirubin : n_days + albumin * copper +
                      eval(parse(text = var2)) : eval(parse(text = var)), 
                         id = id, 
                        data = cirrhosis)
     # aic_vec= c(aic_vec, AIC(model_four))
     chisq_stat=-2 * (logLik(cox_fit2)-logLik(cox_fit))
     p_val = 1 - pchisq(chisq_stat,
                        attr(logLik(cox_fit), "df") - 
                          attr(logLik(cox_fit2),"df"))
     if(p_val < 0.05)
     {
       vars_df = vars_df |> rbind(c(round(p_val, 4), var, var2))
     }
  }
}

# This is our final model.
cox_final = cox_fit2
# summary(cox_final)$coefficient %>% .[, c(1, 2, 5)] |>
#   data.frame() |> mutate(significance = c("", "**", "***", "***", "**", "***", "*",
#                                           "", "", "*", "***", "***")) |> 
#   knitr::kable(col.names = c(" ", "Estimate", "Hazard Ratio", "p value", "Sig."), 
#                digits = 4, caption = "Final Model Parameter Results")
```

```{r evalfinal, warning=FALSE, echo=FALSE}
cox_final |> tbl_regression(
  exponentiate = T,
  estimate_fun = purrr::partial(style_ratio, digits = 4),
  pvalue_fun = purrr::partial(style_sigfig, digits = 4)) |> 
  modify_caption("Final Model Hazard Ratio Estimates")
```

Model evaluation is then conducted on this final model. Figures \ref{fig:deviance} and \ref{fig:coxsnell} show the deviance residuals distribution and the KM estimates using Cox-Snell residuals as pseudo survival time respectively. As there is no obvious trend in the deviance plots and the line is close to the reference line in Cox-Snell plot, it can be concluded that the model is a relatively good fit.

```{r deviance, warning=FALSE, echo=FALSE, fig.width=8,fig.height=6, fig.cap="\\label{fig:deviance}Deviance Residuals Scatterplot for Individual Variable", fig.align='center'}
deviance_res = residuals(cox_final, type = "deviance", var = stage)

dev_drug = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = drug, y = deviance)) +
  geom_point()
dev_age = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = age, y = deviance)) +
  geom_point()
dev_bili = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = bilirubin, y = deviance)) +
  geom_point()
dev_albu = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = albumin, y = deviance)) +
  geom_point()
dev_copper = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = copper, y = deviance)) +
  geom_point()
dev_sgot = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = sgot, y = deviance)) +
  geom_point()
dev_proth = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = prothrombin, y = deviance)) +
  geom_point()
dev_stage = cirrhosis |> 
  mutate(deviance = deviance_res) |> 
  ggplot(aes(x = stage, y = deviance)) +
  geom_point()

ggarrange(dev_drug, dev_age, dev_bili, dev_albu, dev_copper, 
          dev_sgot, dev_proth, dev_stage, ncol = 4, nrow = 2)

# plot(deviance_res, ylab = "Deviance Residuals", xlab = "Index",
#      main = "Deviance Residuals Scatterplot")
# abline(h = c(-3, 3), col = "red", lty = 2) # Flag large residuals
# which(deviance_res > 3)
```

```{r coxsnell, warning=FALSE, echo=F, fig.width=5, fig.height=3, fig.cap="KM Estimates Using Cox-Snell Residuals", fig.align='center'}
coxsnell_res = - (predict(cox_final, type = "survival") |> log())
# hist(coxsnell_res, main = "Cox-Snell Residuals Histogram", freq = F, breaks = 15)
# curve(exp(- x), add = T, col = "red")
# plot(coxsnell_res, ylab = "Cox-Snell Residuals", xlab = "Index",
#      main = "Cox-Snell Residuals Scatterplot")
km_fit = cirrhosis |> mutate(pseudo_time = coxsnell_res) |> 
  survfit(Surv(pseudo_time, status) ~ 1, id = id, data = _)
km_summary = summary(km_fit)
tibble(
  t = km_summary$time,
  survival = km_summary$surv
) |> 
  mutate(y = log(- log(survival))) |> 
  ggplot(aes(x = log(t), y = y)) +
  geom_line() +
  geom_abline(intercept = 0, slope = 1, color = "red", lty = 2) +
  labs(y = "log(-log(S(t)))", title = "")
```


```{r, warning=FALSE, echo=FALSE, fig.width=8, fig.height=6}
ld_res = c()
for(i in 1 : nrow(cirrhosis))
{
  dat = cirrhosis |> slice(- i)
  model_ld = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                   bilirubin + albumin + copper + sgot + prothrombin + stage +
                   bilirubin : n_days + albumin * copper, 
                 id = id, data = dat)
  ld_res = c(ld_res, 2 * abs(logLik(model_ld) - logLik(cox_final)))
}
```

For influence diagnostics, the individuals that provide the 5 largest absolute differences for the LD option are selected. After removing the outliers (identified by a deviance residual larger than 3, 2 are selected) and the 5 influential individuals, the model is re-fit. Table \ref{tab:evalcomparison} compares the model estimates for the two models. There are subtle differences between model estimates, but the direction of impact stays the same for all the variables, thus resulting in similar conclusions.

```{r evalcomparison, warning=F, echo=FALSE}
cox_after = cirrhosis |> 
  slice(c(- 77, - 143, - 82, - 100, - 108, - 129, - 210)) |> 
  coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                   bilirubin + albumin + copper + sgot + prothrombin + stage +
                   bilirubin : n_days + albumin * copper, 
                 id = id, data = _)
summary(cox_final)$coefficient %>% .[, c(1, 2, 5)] |>
  cbind(summary(cox_after)$coefficient %>% .[, c(1, 2, 5)]) |> 
  knitr::kable(col.names = c(" ", rep(c("Estimate", "Hazard Ratio", "p value"), 2)), 
               digits = 4, caption = "Model Parameter Estimates Comparison") |> 
  add_header_above(header = c(" " = 1, "Original Model" = 3, "New Model" = 3))
```

# Discussion

The analysis demonstrates that D-penicillamine is inefficient in improving survival outcomes for patients with primary biliary cirrhosis (PBC). The hazard ratio for those treated with the drug is 1.2720 compared to placebo, indicating no survival benefit and a potential negative effect. This finding suggests the need to reconsider its use and focus on alternative therapies that may offer greater efficacy.

Age and disease stage emerged as critical determinants of survival, underscoring the importance of early detection and stage-specific care. The hazard of mortality increases significantly with each advancing stage, with Stage 4 patients facing an eightfold higher risk compared to Stage 1. Early interventions to halt disease progression are vital, as is tailoring treatment strategies to the patient's disease stage.

Liver function indicators such as Bilirubin, Copper, SGOT, Prothrombin, and Albumin are vital in survival outcomes. Elevated Bilirubin, SGOT, and Prothrombin levels are associated with higher hazards, reflecting liver damage and dysfunction. Conversely, higher albumin levels provide a strong protective effect, emphasizing the importance of maintaining good nutritional and synthetic liver function. The modest protective impact of Copper is proved by previous studies where Copper deficiency is identified as a risk factor for mortality in advanced liver disease [@yu2019copper]. These findings highlight the necessity of monitoring liver function and metabolic health closely to identify high-risk patients and address reversible factors.

The analysis also revealed key interactions affecting survival. A negative Albumin-Copper interaction was observed, indicating a synergistic detrimental effect. This underscores the complexity of metabolic interactions in liver disease and the need to address deficiencies or toxicities in a balanced manner. Furthermore, continued investigation of other potential interactions is needed to uncover personalized treatment strategies.

To improve patient outcomes, it is crucial to monitor high-risk patients routinely, focusing on those with poor liver function indicators or advanced disease stages. Additionally, conducting biological investigations into the protective role of copper and its interactions with other variables could provide valuable insights. These efforts can pave the way for personalized therapies that address the unique risk profiles of individual patients and enhance survival outcomes.

# Conclusion

# References