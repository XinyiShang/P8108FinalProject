---
title: "Cox_Models & Model Evaluation"
author: "Ixtaccihuatl Obregon, Jane Ma"
date: "`r Sys.Date()`"
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(RColorBrewer)
library(corrplot)
library(gtsummary)
library(flextable)
library(stringr)
library(survival)
library(survminer)
library(kableExtra)
```

## COX MODELS 
Using the stepwise selection model: age + edema + bilirubin + albumin + copper + sgot + prothrombin + stage will be used 
```{r}
cirrhosis = read_csv("data/cirrhosis.csv")|> 
  janitor::clean_names() |>
  mutate(age = round(age / 365),
         sex = if_else(sex == "M", "Male", "Female"), 
         ascites = if_else(ascites == "N", "No", "Yes"), 
         hepatomegaly = if_else(hepatomegaly == "N", "No", "Yes"),
         spiders = if_else(spiders == "N", "No", "Yes"), 
         edema = if_else(edema == "N", "No", "Yes"),
         stage = factor(stage),
         drug = factor(drug, levels = c("Placebo", "D-penicillamine"), order = T)) |> 
  na.omit()
cirrhosis = cirrhosis |> 
  mutate(
    status = case_when(
      status == "D" ~ 1,  # Event of interest (death)
      status == "C" | status == "CL" ~ 0,  # Censored data
      TRUE ~ as.numeric(status)))

# cox model based on stepwise selection varibales above (ixta)
cox_model_a = coxph(Surv(n_days, status) ~ drug + age + edema + 
                          bilirubin + albumin + copper + sgot +
                          prothrombin + stage, 
                    id=id,
                   data = cirrhosis)

# Summarize the results
cox_summary_a = tbl_regression(cox_model_a, exponentiate = TRUE) |> 
  modify_caption("Multivariate Cox Proportional Hazards Analysis")
cox_summary_a
surv_fit_cox_a = survfit(cox_model_a)
plot(surv_fit_cox_a, xlab = "Days", ylab = "Survival Probability", main = "Survival Curves - Unadjusted")
#ggforest(cox_model_a, data = cirrhosis, main = "Hazard Ratios for Cox Model")
```

# Check PH Assumption 
```{r}
ph_assumption_a = cox.zph(cox_model_a)
plot(ph_assumption_a)
ph_assumption_df = as.data.frame(ph_assumption_a$table)
knitr::kable(ph_assumption_df, caption = "Proportional Hazards Assumption Test for Cox PH Model Unadjusted")

```
edema pval=0.0165; varies over time violating the proportional hazards assumption. 
bilirubin pval=0.0038; varies over time violating the proportional hazards assumption. 
prothrombin pval=0.0211;  varies over time violating the proportional hazards assumption.
global pval=0.0037; varies over time violating the proportional hazards assumption for overall model. 

If assumptions not met: 
- do a stratified analysis
- include a time-varying covariate to allow changing hazard ratios over time
- include interactions with time

# Checking Drug Variation 
```{r}
#checking if drug is actually useful for the model 
summary(cirrhosis$drug) 
table(cirrhosis$drug)
cox_model_drug = coxph(Surv(n_days, status) ~ drug, data = cirrhosis, id=id)
summary(cox_model_drug) 
```

pval=0.5 drug does not have a significant impact on survival outcomes, and we might consider removing it. 

# Stratification of Edema 
```{r}
cox_model_edema_strat_simple = coxph(Surv(n_days, status) ~ strata(edema), id = id, data = cirrhosis)

cox_model_edema_strat = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                                bilirubin + albumin + copper + sgot +
                                prothrombin + stage,
                                id = id,
                                data = cirrhosis)
ph_assumption_edema_strat = cox.zph(cox_model_edema_strat) 
ph_assumption_edema = as.data.frame(ph_assumption_edema_strat$table)
knitr::kable(ph_assumption_edema, caption = "Proportional Hazards Assumption Test COX PH Model Stratified for Edema")

surv_fit_edema_strat = survfit(cox_model_edema_strat)
plot(surv_fit_edema_strat, 
     xlab = "Days", 
     ylab = "Survival Probability", 
     main = "Survival Curves - Edema Stratified", 
     col = c("blue", "red"),  # Assigning colors to the strata
     lty = 1,                 # Line type (solid)
     lwd = 2)                 # Line width
#ggforest(cox_model_edema_strat, data = cirrhosis, main = "Hazard Ratios for Cox Model Edema Stratified")
```
bilirubin pval=0.0006; varies over time violating the proportional hazards assumption. 
global pval=0.0153; varies over time violating the proportional hazards assumption for overall model.

# Time-varying covariate to allow changing hazard ratios over time
```{r}
# checking if the dataset allows for time-varying covariates
table(cirrhosis$id)  
sum(table(cirrhosis$id) > 1)
```
Only one observation per id therefore can not to time-varying model. 


# Rescaling bilirubin and prothrombin 
Try to see if rescaling helps. 
```{r}
cox_model_logs = coxph(Surv(n_days, status) ~ age + edema + 
                         log(bilirubin) + albumin + copper + sgot +
                          log(prothrombin) + stage,
                        data = cirrhosis, id=id)

#ggforest(cox_model_logs, data = cirrhosis, main = "Hazard Ratios for Cox Model Log(bilirubin) and log(prothrombin)")
cox.zph(cox_model_logs) # violation in  edema, log(pro)

cox_model_logpro = coxph(Surv(n_days, status) ~ age + edema + 
                         bilirubin + albumin + copper + sgot +
                          log(prothrombin) + stage,
                        data = cirrhosis, id=id)

#ggforest(cox_model_logpro, data = cirrhosis, main = "Hazard Ratios for Cox Mode log(prothrombin)")
cox.zph(cox_model_logpro) # violation in  edema, bili, log(pro)

cox_model_logbili = coxph(Surv(n_days, status) ~ age + edema + 
                         log(bilirubin) + albumin + copper + sgot +
                          prothrombin + stage,
                        data = cirrhosis, id=id)

#ggforest(cox_model_logbili, data = cirrhosis, main = "Hazard Ratios for Cox Mode log(bilirubin)")
cox.zph(cox_model_logbili) # violation in  edema,  log(pro)
```
Violations still occur with re scaling. But for log(bilirubin) and log(prothrombin) global pval=0.09 so ok model?

# Interactions with Time
```{r}
cox_model_timeint_all = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                          bilirubin + albumin + copper + sgot +
                          prothrombin + stage + bilirubin:n_days + prothrombin : n_days,
                          id=id,
                        data = cirrhosis |> na.omit())
#ggforest(cox_model_timeint_all, data = cirrhosis, main = "Hazard Ratios for Cox Model Time Interaction for bilirubin and prothrombin")
ph_assumption_bili_pro = cox.zph(cox_model_timeint_all) # violation in bilirubin, but global pval > 0.05
ph_assumption_bp= as.data.frame(ph_assumption_bili_pro$table)
knitr::kable(ph_assumption_bp, caption = "Proportional Hazards Assumption Test COX PH Model - Time Interaction for Bilirubin and Prohrombin")

cox_model_timeint_bil = coxph(Surv(n_days, status) ~ age + strata(edema) + 
                          bilirubin + albumin + copper + sgot +
                          prothrombin + stage + bilirubin : n_days , 
                       id=id, 
                        data = cirrhosis)
#ggforest(cox_model_timeint_bil, data = cirrhosis, main = "Hazard Ratios for Cox Model Time Interaction for bilirubin")
ph_assumption_bili = cox.zph(cox_model_timeint_bil) # violation in bilirubin, but global pval > 0.05
ph_assumption_b = as.data.frame(ph_assumption_bili$table)
knitr::kable(ph_assumption_b, caption = "Proportional Hazards Assumption Test COX PH Model - Time Interaction for Bilirubin")

cox_model_timeint_pro = coxph(Surv(n_days, status) ~ age + strata(edema) + 
                          bilirubin + albumin + copper + sgot +
                          prothrombin + stage + prothrombin : n_days, 
                         id=id, 
                        data = cirrhosis)
#ggforest(cox_model_timeint_pro, data = cirrhosis, main = "Hazard Ratios for Cox Model Time Interaction for prothrombin")
ph_assumption_pro = cox.zph(cox_model_timeint_pro) # no violation 
ph_assumption_p = as.data.frame(ph_assumption_pro$table)
knitr::kable(ph_assumption_p, caption = "Proportional Hazards Assumption Test COX PH Model - Time Interaction for Prothrombin")


tibble(
  Model = c(
    "Plain",
    "Stratified by Edema",
    "Time Interaction Bilirubin and Prothrombin", 
    "Time Interaction Bilirubin", 
    "Time Interaction Prothrombin"
  ), 
  AIC = c(
    AIC(cox_model_a),
    AIC(cox_model_edema_strat),
    AIC(cox_model_timeint_all),
    AIC(cox_model_timeint_bil),
    AIC(cox_model_timeint_pro)
  )
) |> knitr::kable(caption = "AIC Comparison between Different Models")
```

We use the model stratified by Edema and with the interaction with time for bilirubin and prothrombin. The coefficients are:
```{r}
tbl_regression(cox_model_timeint_all, exponentiate = TRUE) |> 
  modify_caption("Multivariate Cox Proportional Hazards Analysis")
```

It can be concluded that prothrombin and stage are significantly associated with survival risk. As we stratified by edema, edema is also a potential significant factor. The result complies with what was discovered in the KM model.

# Interaction between Convariates
```{r, warning=FALSE}
cox_init = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                                bilirubin + albumin + copper + sgot +
                                prothrombin + stage + bilirubin : n_days, 
                         id = id, 
                        data = cirrhosis |> na.omit())
variables = c("drug", "age", "albumin", "copper", "sgot",
              "prothrombin", "stage")
vars_df = tibble()
for(var in variables[1 : (length(variables) - 1)])
{
  left_vars = variables[(which(variables == var) + 1) : length(variables)]
  for(var2 in left_vars)
  {
    cox_fit = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                                bilirubin + albumin + copper + sgot +
                                prothrombin + stage + bilirubin : n_days +
                      eval(parse(text = var2)) : eval(parse(text = var)), 
                         id = id, 
                        data = cirrhosis |> na.omit())
     # aic_vec= c(aic_vec, AIC(model_four))
     chisq_stat=-2 * (logLik(cox_init)-logLik(cox_fit))
     p_val = 1 - pchisq(chisq_stat,
                        attr(logLik(cox_fit), "df") - 
                          attr(logLik(cox_init),"df"))
     if(p_val < 0.05)
     {
       vars_df = vars_df |> rbind(c(round(p_val, 4), var, var2))
     }
  }
}

colnames(vars_df) = c("p_value", "variable1", "variable2")
vars_df |> 
  mutate(interaction = paste0(variable1, " * ", variable2)) |> 
  select(interaction, p_value) |> 
  knitr::kable(col.names = c("Interaction Term", "P Value"),
    caption = "Siginificant Interaction term")
```

We first add the albumin*copper term into the model and evaluate again.

```{r, warning=FALSE}
cox_fit2 = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                   bilirubin + albumin + copper + sgot + prothrombin + stage +
                   bilirubin : n_days + albumin * copper, 
                 id = id, data = cirrhosis)
vars_df = tibble()
for(var in variables[1 : (length(variables) - 1)])
{
  left_vars = variables[(which(variables == var) + 1) : length(variables)]
  for(var2 in left_vars)
  {
    cox_fit = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                      bilirubin + albumin + copper + sgot + prothrombin + 
                      stage + bilirubin : n_days + albumin * copper +
                      eval(parse(text = var2)) : eval(parse(text = var)), 
                         id = id, 
                        data = cirrhosis)
     # aic_vec= c(aic_vec, AIC(model_four))
     chisq_stat=-2 * (logLik(cox_fit2)-logLik(cox_fit))
     p_val = 1 - pchisq(chisq_stat,
                        attr(logLik(cox_fit), "df") - 
                          attr(logLik(cox_fit2),"df"))
     if(p_val < 0.05)
     {
       vars_df = vars_df |> rbind(c(round(p_val, 4), var, var2))
     }
  }
}
```

This is our final model.
```{r, warning=FALSE}
cox_final = cox_fit2
summary(cox_final)$coefficient %>% .[, c(1, 2, 5)] |>
  data.frame() |> mutate(significance = c("", "**", "***", "***", "**", "***", "*",
                                          "", "", "*", "***", "***")) |> 
  knitr::kable(col.names = c(" ", "Estimate", "Hazard Ratio", "p value", "Sig."), 
               digits = 4, caption = "Final Model Parameter Results")
```

# Model Evaluation
```{r}
deviance_res = residuals(cox_final, type = "deviance")

plot(deviance_res, ylab = "Deviance Residuals", xlab = "Index",
     main = "Deviance Residuals Scatterplot")
abline(h = c(-3, 3), col = "red", lty = 2) # Flag large residuals
which(deviance_res > 3)
```

```{r}
coxsnell_res = - (predict(cox_final, type = "survival") |> log())
hist(coxsnell_res, main = "Cox-Snell Residuals Histogram", freq = F, breaks = 15)
curve(exp(- x), add = T, col = "red")
plot(coxsnell_res, ylab = "Cox-Snell Residuals", xlab = "Index",
     main = "Cox-Snell Residuals Scatterplot")
km_fit = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                   bilirubin + albumin + copper + sgot + prothrombin + stage +
                   bilirubin : n_days + albumin * copper, 
                 id = id, data = cirrhosis)
summary(km_fit)
cirrhosis |> pull(n_days) |> hist()
abline(h = 3, col= "red", lty = 2)
```

```{r}
fit_cumhaz = coxph(Surv(n_days, status) ~ 1, id = id, data = cirrhosis)
baseline_hazard = basehaz(fit_cumhaz)

# Plot cumulative hazard against residuals
plot(baseline_hazard$time, baseline_hazard$hazard, type = "l",
     xlab = "Cox-Snell Residuals", ylab = "Cumulative Hazard",
     main = "Cox-Snell Residuals vs Cumulative Hazard")
abline(0, 1, col = "red", lty = 2)  
```

Based on the plot, the Cox-Snell residuals approximately follow exponential (1) distribution, which indicates good fit of the model.

For influence diagnostics, we use the LD option. We calculate it manually and select the individuals that provide the 5 largest absolute differences.
```{r, warning=FALSE}
ld_res = c()
for(i in 1 : nrow(cirrhosis))
{
  dat = cirrhosis |> slice(- i)
  model_ld = coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                   bilirubin + albumin + copper + sgot + prothrombin + stage +
                   bilirubin : n_days + albumin * copper, 
                 id = id, data = dat)
  ld_res = c(ld_res, 2 * abs(logLik(model_ld) - logLik(cox_final)))
}
hist(ld_res)
```

The indices for the patients who seem to have a lot of influence on the model based on the LD option are `r which((ld_res |> order(decreasing = T)) <= 5)`.

```{r, warning=F}
cox_after = cirrhosis |> 
  slice(c(- 77, - 143, - 82, - 100, - 108, - 129, - 210)) |> 
  coxph(Surv(n_days, status) ~ drug + age + strata(edema) + 
                   bilirubin + albumin + copper + sgot + prothrombin + stage +
                   bilirubin : n_days + albumin * copper, 
                 id = id, data = _)
summary(cox_final)$coefficient %>% .[, c(1, 2, 5)] |>
  cbind(summary(cox_after)$coefficient %>% .[, c(1, 2, 5)]) |> 
  knitr::kable(col.names = c(" ", rep(c("Estimate", "Hazard Ratio", "p value"), 2)), 
               digits = 4, caption = "Model Parameter Results Comparison") |> 
  add_header_above(header = c(" " = 1, "Original Model" = 3, "New Model" = 3))
```

